<!doctype html><html lang="pt-BR"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Painel Médico – Queimadas Telemedicina</title>
<link rel="stylesheet" href="style.css">
<style>
.container{max-width:1100px;margin:20px auto;padding:16px}
.card{background:#fff;border:1px solid #e6ebf5;border-radius:12px;padding:16px;margin-bottom:16px}
h2{margin:0 0 12px}
input,button{padding:10px 12px;border-radius:10px;border:1px solid #cfd8ea}
button{background:#0e8240;color:#fff;border:none;font-weight:700;cursor:pointer}
.row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.table{width:100%;border-collapse:collapse}
.table th,.table td{border-bottom:1px solid #e6ebf5;padding:8px 6px;text-align:left;vertical-align:top}
.badge{display:inline-block;background:#eef6ff;color:#264b82;padding:3px 8px;border-radius:999px;font-size:12px}
pre{white-space:pre-wrap;font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
.alert{padding:10px 12px;border-radius:10px;background:#fff6d7;border:1px solid #f1d188;margin-bottom:10px}
.top{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
a{color:#0e8240;text-decoration:none;font-weight:700}
.small{font-size:12px;color:#5b6b8e}
</style></head><body>
<header><img class="qbanner" src="prefeitura-queimadas.jpg" alt=""><h1>Painel do Médico</h1></header>
<main class="container">
  <div class="card" id="loginBox">
    <h2>Acesso do Médico</h2>
    <div class="row">
      <input id="cpf" placeholder="CPF do médico">
      <input id="pw" type="password" placeholder="Senha">
      <button id="btnLogin">Entrar</button>
    </div>
    <div class="small">Definidos nas variáveis de ambiente: ADMIN_CPF e ADMIN_PASSWORD.</div>
  </div>

  <div id="app" style="display:none">
    <div class="top"><h2>Documentos pendentes</h2><a href="#" id="logout">Sair</a></div>
    <div class="card">
      <table class="table" id="docsTable"><thead>
        <tr><th>ID</th><th>Paciente</th><th>CPF</th><th>Tipo</th><th>Status</th><th>Ações</th></tr>
      </thead><tbody></tbody></table>
    </div>

    <div class="card">
      <h2>Histórico por CPF</h2>
      <div class="row">
        <input id="cpfBusca" placeholder="CPF do paciente">
        <button id="btnBuscar">Buscar</button>
      </div>
      <div id="hist"></div>
    </div>
  </div>
</main>

<script type="module">
const API_BASE = (localStorage.getItem('API_BASE')||'https://remedy-queimadas-api.onrender.com');
function at(){ return localStorage.getItem('ADMIN_TOKEN')||''; }

async function apiAdmin(path, method='GET', data=null){
  const headers = { 'Content-Type':'application/json' };
  const t = at(); if(t) headers['Authorization'] = 'Bearer '+t;
  const resp = await fetch(API_BASE+path, { method, headers, body: data?JSON.stringify(data):undefined });
  return resp.json();
}

const loginBox = document.getElementById('loginBox');
const app = document.getElementById('app');
const docsTableBody = document.querySelector('#docsTable tbody');

async function refreshDocs(){
  const d = await apiAdmin('/admin/docs');
  if(!d.ok){ docsTableBody.innerHTML = '<tr><td colspan="6">Nenhum documento pendente.</td></tr>'; return; }
  docsTableBody.innerHTML = (d.items||[]).map(it=>`
    <tr>
      <td>${it.id}</td>
      <td>${it.pacienteNome||''}</td>
      <td>${it.pacienteCPF||''}</td>
      <td><span class="badge">${it.tipo||''}</span></td>
      <td>${it.status}</td>
      <td>
        <button data-act="approve" data-id="${it.id}">Aprovar</button>
        <button data-act="reject" data-id="${it.id}" style="background:#9b1c1c">Rejeitar</button>
      </td>
    </tr>
  `).join('');
}
docsTableBody.addEventListener('click', async (e)=>{
  const b = e.target.closest('button'); if(!b) return;
  const id = b.dataset.id; const act=b.dataset.act;
  const ep = act==='approve'?'/admin/docs/'+id+'/approve':'/admin/docs/'+id+'/reject';
  const r = await apiAdmin(ep,'POST',{});
  if(r.ok) refreshDocs(); else alert('Ação falhou');
});

document.getElementById('btnLogin').onclick = async ()=>{
  const cpf = document.getElementById('cpf').value.trim();
  const password = document.getElementById('pw').value;
  const r = await apiAdmin('/admin/login','POST',{ cpf, password });
  if(r.ok && r.token){ localStorage.setItem('ADMIN_TOKEN', r.token); loginBox.style.display='none'; app.style.display='block'; refreshDocs(); }
  else alert(r.error||'Falha no login');
};
document.getElementById('logout').onclick = ()=>{ localStorage.removeItem('ADMIN_TOKEN'); location.reload(); };

document.getElementById('btnBuscar').onclick = async ()=>{
  const cpf = (document.getElementById('cpfBusca').value||'').trim();
  if(!cpf){ alert('Informe o CPF'); return; }
  const r = await apiAdmin('/admin/patient/'+encodeURIComponent(cpf)+'/history');
  const hist = document.getElementById('hist');
  if(!r.ok){ hist.innerHTML = '<div class="alert">Paciente não encontrado.</div>'; return; }
  hist.innerHTML = `
    <div class="alert"><strong>${r.patient.name}</strong> • ${r.patient.cpf} • ${r.patient.email||''}</div>
    ${(r.items||[]).map(it=>`
      <div class="item" style="margin-bottom:10px">
        <div class="small"><strong>${it.specialty||'Geral'}</strong> • ${new Date(it.created_at||Date.now()).toLocaleString()}</div>
        <pre>${(it.conteudo||'').replace(/[<>&]/g, s=>({'<':'&lt;','>':'&gt;','&':'&amp;'}[s]))}</pre>
      </div>
    `).join('') || '<div class="small">Sem registros.</div>'}
  `;
};

if(localStorage.getItem('ADMIN_TOKEN')){ loginBox.style.display='none'; app.style.display='block'; refreshDocs(); }
</script>
</body></html>