
<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Área do Médico Administrador</title>
  <style>
    :root{--azul:#0f3446;--borda:#d9e5ee;--cinza:#f4f7fb;--verde:#127c52}
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--cinza)}
    header{background:var(--azul);color:#fff;padding:22px 16px}
    header .row{max-width:1100px;margin:0 auto;display:flex;align-items:center;gap:14px}
    header img{height:44px;object-fit:contain}
    header h1{margin:0;font-size:1.5rem}
    main{max-width:1100px;margin:22px auto;padding:0 16px}
    .bar{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:12px}
    input, button, select{border:1px solid var(--borda);border-radius:10px;padding:10px 12px}
    button{background:var(--azul);color:#fff;border:none;cursor:pointer}
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin:14px 0}
    .kpi{background:#fff;border:1px solid var(--borda);border-radius:12px;padding:12px;text-align:center}
    .kpi b{font-size:1.4rem;display:block;margin-top:6px}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--borda);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--borda);font-size:.95rem}
    th{background:#f8fbff;text-align:left}
    td .btn{background:#0f3446;color:#fff;border:none;border-radius:8px;padding:6px 10px;margin:2px;cursor:pointer}
    .right{margin-left:auto}
  </style>
</head>
<body>
<header>
  <div class="row">
    <img src="img/logo-queimadas.png" onerror="this.style.display='none'"/>
    <h1>Área do Médico Administrador</h1>
    <span class="right"></span>
    <button onclick="logout()">Sair</button>
  </div>
</header>

<main>
  <div class="bar">
    <label>Período inicial <input type="date" id="dini"></label>
    <label>Período final <input type="date" id="dfim"></label>
    <button onclick="loadDocs()">Buscar</button>
    <button onclick="printPeriod()">Imprimir PDFs do período</button>
  </div>

  <div class="grid">
    <div class="kpi">Total<b id="kTotal">0</b></div>
    <div class="kpi">Pendentes<b id="kPend">0</b></div>
    <div class="kpi">Aprovados<b id="kAprov">0</b></div>
    <div class="kpi">Rejeitados<b id="kRej">0</b></div>
  </div>

  <table id="tbl">
    <thead>
      <tr><th>ID</th><th>Paciente</th><th>CPF</th><th>Tipo</th><th>Status</th><th>Data</th><th>Ações</th></tr>
    </thead>
    <tbody></tbody>
  </table>
</main>

<script>
  const DEFAULT_API = "https://remedy-queimadas-api.onrender.com";
  const API_BASE = window.API_BASE || DEFAULT_API;

  const $ = s=>document.querySelector(s);

  function logout(){
    location.href = "index.html";
  }

  async function loadDocs(){
    const dini = $("#dini").value, dfim = $("#dfim").value;
    let url = `${API_BASE}/admin/docs`;
    const qs = [];
    if(dini) qs.push(`from=${dini}`);
    if(dfim) qs.push(`to=${dfim}`);
    if(qs.length) url += `?${qs.join("&")}`;

    let list = [];
    try{
      const r = await fetch(url, {mode:"cors"});
      if(!r.ok) throw new Error("fail");
      list = await r.json();
    }catch(e){
      // fallback: lista vazia
      list = [];
    }
    const tb = $("#tbl tbody"); tb.innerHTML = "";
    let total=0, pend=0, aprov=0, rej=0;
    list.forEach(doc=>{
      total++;
      if(doc.status==="pendente") pend++;
      else if(doc.status==="aprovado") aprov++;
      else if(doc.status==="rejeitado") rej++;

      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${doc.id||"-"}</td>
        <td>${doc.patient_name||"-"}</td>
        <td>${doc.cpf||"-"}</td>
        <td>${doc.type||"receita"}</td>
        <td>${doc.status||"pendente"}</td>
        <td>${doc.created_at||"-"}</td>
        <td>
          <button class="btn" onclick="viewDoc(${doc.id})">Ver/Editar</button>
          <button class="btn" onclick="approveDoc(${doc.id})">Aprovar</button>
          <button class="btn" onclick="rejectDoc(${doc.id})">Rejeitar</button>
          <button class="btn" onclick="printDoc(${doc.id})">Imprimir</button>
        </td>`;
      tb.appendChild(tr);
    });
    $("#kTotal").textContent = total;
    $("#kPend").textContent = pend;
    $("#kAprov").textContent = aprov;
    $("#kRej").textContent = rej;
  }

  function printPeriod(){
    window.print();
  }

  async function viewDoc(id){
    alert("Abrir editor simplificado do documento "+id+" (a UI completa continua no seu backend).");
  }
  async function approveDoc(id){
    try{ await fetch(`${API_BASE}/admin/docs/${id}/approve`, {method:"POST"}); }catch(e){}
    loadDocs();
  }
  async function rejectDoc(id){
    try{ await fetch(`${API_BASE}/admin/docs/${id}/reject`, {method:"POST"}); }catch(e){}
    loadDocs();
  }
  function printDoc(id){
    window.open(`${API_BASE}/admin/docs/${id}/pdf`, "_blank");
  }

  // auto carregar ao abrir
  loadDocs();
</script>
</body>
</html>
