<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Área do Médico Administrador</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body{background:#f5f7fb;font-family:system-ui,Segoe UI,Roboto,Arial}
    .container{max-width:1100px;margin:20px auto;padding:16px;background:#fff;border:1px solid #e5e7eb;border-radius:12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end}
    .row > *{flex:1}
    label{display:block;font-weight:600;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    button{padding:10px 16px;border:1px solid #0f172a;background:#0f172a;color:#fff;border-radius:8px;cursor:pointer}
    button.secondary{background:#fff;color:#0f172a}
    .stats{display:flex;gap:10px}
    .stat{flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;background:#f8fafc}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th, td{border-top:1px solid #e5e7eb;padding:8px;text-align:left;font-size:14px}
    .right{ text-align:right }
    .hide{display:none}
  </style>
</head>
<body>
<header class="container">
  <h2>Área do Médico Administrador</h2>
  <p>Valide receitas, relatórios, encaminhamentos e visualize atendimentos.</p>
</header>

<main class="container">
  <section id="loginSec">
    <div class="row">
      <label>CPF<br><input id="cpf" placeholder="Apenas números"></label>
      <label>Senha<br><input id="pwd" type="password"></label>
      <div><button id="entrar">Entrar</button></div>
    </div>
    <p id="loginMsg"></p>
  </section>

  <section id="dashSec" class="hide">
    <div class="row">
      <label>Período inicial<br><input type="date" id="start"></label>
      <label>Período final<br><input type="date" id="end"></label>
      <div><button id="buscar">Buscar</button></div>
      <div><button id="imprimir" class="secondary">Imprimir PDFs do período</button></div>
      <div class="right"><button id="sair" class="secondary">Sair</button></div>
    </div>

    <div class="stats">
      <div class="stat">Total<br><b id="stTotal">0</b></div>
      <div class="stat">Pendentes<br><b id="stPend">0</b></div>
      <div class="stat">Aprovados<br><b id="stApr">0</b></div>
      <div class="stat">Rejeitados<br><b id="stRej">0</b></div>
    </div>

    <table id="tabela">
      <thead><tr><th>ID</th><th>Paciente</th><th>CPF</th><th>Tipo</th><th>Status</th><th>Data</th><th>Ações</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<script>
  const API = localStorage.getItem('API_BASE') || 'https://remedy-queimadas-api.onrender.com';
  let adminToken = localStorage.getItem('adm_token') || '';

  const loginSec = document.getElementById('loginSec');
  const dashSec = document.getElementById('dashSec');
  const msg = document.getElementById('loginMsg');
  const cpf = document.getElementById('cpf');
  const pwd = document.getElementById('pwd');
  const entrar = document.getElementById('entrar');
  const sair = document.getElementById('sair');
  const start = document.getElementById('start');
  const end = document.getElementById('end');
  const buscar = document.getElementById('buscar');
  const imprimir = document.getElementById('imprimir');
  const tbody = document.querySelector('#tabela tbody');
  const stTotal = document.getElementById('stTotal');
  const stPend = document.getElementById('stPend');
  const stApr  = document.getElementById('stApr');
  const stRej  = document.getElementById('stRej');

  function showDash(on){
    loginSec.classList.toggle('hide', on);
    dashSec.classList.toggle('hide', !on);
  }

  function authHeaders(){
    return adminToken ? { Authorization: 'Bearer '+adminToken } : {};
  }
  async function api(path, options){
    const res = await fetch(API+path, { ...(options||{}), headers: { 'Content-Type':'application/json', ...(options&&options.headers||{}), ...authHeaders() } });
    if(!res.ok) throw new Error(await res.text());
    const ct = res.headers.get('content-type')||'';
    return ct.includes('application/json') ? res.json() : res.text();
  }

  async function doLogin(){
    msg.textContent = 'Validando credenciais...';
    try{
      const j = await api('/auth/login', { method:'POST', body: JSON.stringify({ cpf: cpf.value.replace(/\\D+/g,''), password: pwd.value }) });
      adminToken = j.token;
      localStorage.setItem('adm_token', adminToken);
      msg.textContent = '';
      showDash(true);
    }catch(e){
      msg.textContent = 'Falha no login: ' + e.message;
    }
  }
  entrar.onclick = doLogin;
  sair.onclick = ()=>{ adminToken=''; localStorage.removeItem('adm_token'); showDash(false); };

  async function carregar(){
    const qs = `?start=${start.value||''}&end=${end.value||''}`;
    const sum = await api('/admin/summary'+qs);
    stTotal.textContent = sum.total;
    stPend.textContent = sum.pendentes;
    stApr.textContent = sum.aprovados;
    stRej.textContent = sum.rejeitados;

    const data = await api('/admin/docs'+qs);
    tbody.innerHTML = '';
    (data.items||[]).forEach(d=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${d.id}</td>
        <td>${d.pacienteNome||'-'}</td>
        <td>${d.pacienteCPF||'-'}</td>
        <td>${d.tipo}</td>
        <td>${d.status}</td>
        <td>${new Date(d.createdAt).toLocaleString()}</td>
        <td>
          <button data-id="${d.id}" data-s="aprovado">Aprovar</button>
          <button data-id="${d.id}" data-s="rejeitado" class="secondary">Rejeitar</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }

  buscar.onclick = carregar;
  tbody.onclick = async (ev)=>{
    const b = ev.target.closest('button'); if(!b) return;
    const id = Number(b.dataset.id||0), status = b.dataset.s;
    await api('/admin/docs/'+id+'/status', { method:'POST', body: JSON.stringify({ status }) });
    await carregar();
  }

  imprimir.onclick = ()=>{
    const qs = `?start=${start.value||''}&end=${end.value||''}&token=${encodeURIComponent(adminToken)}`;
    window.open(API+'/admin/docs/pdf'+qs, '_blank');
  }

  // Estado inicial
  if(adminToken){ showDash(true); } else { showDash(false); }
</script>
</body>
</html>