<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Área do Médico Administrador</title>
<link rel="stylesheet" href="style.css">
<style>
  .row{display:flex;gap:12px;flex-wrap:wrap;margin:8px 0}
  .card{background:#fff;border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin:8px 0}
  table{width:100%;border-collapse:collapse}
  th,td{padding:8px;border-bottom:1px solid #e5e7eb;font-size:14px}
  .btn{padding:8px 12px;border-radius:10px;background:#0b7a3b;color:#fff;border:0;cursor:pointer}
  .btn.out{background:#0b2b66}
  .chip{display:inline-block;padding:4px 8px;border-radius:999px;background:#eef2ff}
</style>
</head>
<body>
<header>
  <img class="qbanner" src="prefeitura-queimadas.jpg" alt="Prefeitura">
  <h1>Área do Médico Administrador</h1>
  <button class="btn out" onclick="localStorage.removeItem('admin');location.href='admin.html'">Sair</button>
</header>
<main>
<div class="row">
<div>
<label>Buscar histórico por CPF</label>
<input id="histCPF" placeholder="Somente números" inputmode="numeric" maxlength="14">
</div>
<div>
<button id="btnHist">Buscar histórico</button>
</div>
  <div><label>Período inicial</label><input id="dini" type="date"></div>
  <div><label>Período final</label><input id="dfim" type="date"></div>
  <div style="align-self:flex-end"><button class="btn" id="buscar">Buscar</button></div>
  <div style="align-self:flex-end"><button class="btn out" id="imprimirPeriodo">Imprimir PDFs do período</button></div>
</div>

<div class="row">
<div>
<label>Buscar histórico por CPF</label>
<input id="histCPF" placeholder="Somente números" inputmode="numeric" maxlength="14">
</div>
<div>
<button id="btnHist">Buscar histórico</button>
</div>
  <div class="card"><div>Total<br><strong id="kTotal">0</strong></div></div>
  <div class="card"><div>Pendentes<br><strong id="kPend">0</strong></div></div>
  <div class="card"><div>Aprovados<br><strong id="kApr">0</strong></div></div>
  <div class="card"><div>Rejeitados<br><strong id="kRej">0</strong></div></div>
</div>

<div class="row">
<div>
<label>Buscar histórico por CPF</label>
<input id="histCPF" placeholder="Somente números" inputmode="numeric" maxlength="14">
</div>
<div>
<button id="btnHist">Buscar histórico</button>
</div>
  <div><label>CPF do paciente (histórico)</label><input id="histCPF" placeholder="Apenas números" inputmode="numeric"></div>
  <div style="align-self:flex-end"><button class="btn out" id="histBtn">Ver histórico</button></div>
</div>
<div id="histBox" class="card" style="display:none"></div>

<div id="lista" class="card">
  <table>
    <thead><tr><th>ID</th><th>Paciente</th><th>CPF</th><th>Tipo</th><th>Status</th><th>Data</th><th>Ações</th></tr></thead>
    <tbody id="tb"></tbody>
  </table>
</div>
</main>

<div id="dlg" class="card" style="display:none;position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);z-index:20;max-width:720px;width:90%;">
  <h3 id="dlgTitle">Documento</h3>
  <div class="row">
<div>
<label>Buscar histórico por CPF</label>
<input id="histCPF" placeholder="Somente números" inputmode="numeric" maxlength="14">
</div>
<div>
<button id="btnHist">Buscar histórico</button>
</div>
    <input id="modalNome" placeholder="Nome do paciente (opcional)" style="flex:2;padding:8px">
    <input id="modalCPF" placeholder="CPF (apenas números)" style="flex:1;padding:8px">
  </div>
  <textarea id="modalTxt" style="width:100%;height:300px"></textarea>
  <div class="row" style="justify-content:flex-end">
    <button class="btn out" id="dlgCancel">Cancelar</button>
    <button class="btn out" id="dlgReject">Rejeitar</button>
    <button class="btn" id="dlgApprove">Aprovar</button>
  </div>
</div>

<script>
const API_BASE = "https://remedy-queimadas-api.onrender.com";
function fmt(d){try{return new Date(d).toLocaleString()}catch(_){return d||''}}
async function api(path, opt={}){
  opt.headers = Object.assign({'Content-Type':'application/json'}, opt.headers||{});
  const r = await fetch(API_BASE+path, opt.method?opt: Object.assign({method:'GET'},opt));
  return r.json();
}

async function loadSummary(){
  const dini = document.getElementById('dini').value;
  const dfim = document.getElementById('dfim').value;
  const s = await api('/admin/summary?start='+(dini||'')+'&end='+(dfim||''));
  document.getElementById('kTotal').textContent = s.total||0;
  document.getElementById('kPend').textContent = s.pendentes||0;
  document.getElementById('kApr').textContent = s.aprovados||0;
  document.getElementById('kRej').textContent = s.rejeitados||0;
}

async function loadDocs(){
  const dini = document.getElementById('dini').value;
  const dfim = document.getElementById('dfim').value;
  const d = await api('/admin/docs?start='+(dini||'')+'&end='+(dfim||''));
  const tb = document.getElementById('tb'); tb.innerHTML='';
  (d.items||[]).forEach(it=>{
    const tr = document.createElement('tr');
    tr.innerHTML = '<td>'+it.id+'</td><td>-</td><td>-</td><td>'+it.tipo+'</td><td><span class="chip">'+it.status+'</span></td><td>'+fmt(it.createdAt)+'</td>'+
      '<td><button class="btn out v" data-id="'+it.id+'">Ver/Editar</button> <button class="btn a" data-id="'+it.id+'">Aprovar</button> <button class="btn out r" data-id="'+it.id+'">Rejeitar</button> <button class="btn out p" data-id="'+it.id+'">Imprimir</button></td>';
    tb.appendChild(tr);
  });
  bindActions(d.items||[]);
}

function bindActions(items){
  function openDlg(item){
    document.getElementById('dlgTitle').textContent = 'Documento #'+item.id+' — '+item.tipo;
    document.getElementById('modalTxt').value = item.conteudo||'';
    document.getElementById('modalNome').value='';
    document.getElementById('modalCPF').value='';
    document.getElementById('dlg').style.display='block';
    document.getElementById('dlgCancel').onclick = ()=> document.getElementById('dlg').style.display='none';
    document.getElementById('dlgReject').onclick = async ()=>{
      await api('/admin/docs/'+item.id+'/reject', { method:'POST', body: JSON.stringify({}) });
      document.getElementById('dlg').style.display='none';
      loadSummary(); loadDocs();
    };
    document.getElementById('dlgApprove').onclick = async ()=>{
      const conteudo = document.getElementById('modalTxt').value;
      await api('/admin/docs/'+item.id+'/approve', { method:'POST', body: JSON.stringify({ conteudo }) });
      const cpf = (document.getElementById('modalCPF').value||'').replace(/\D/g,'');
      const nome = document.getElementById('modalNome').value||'';
      if(cpf){ await api('/records/store', { method:'POST', body: JSON.stringify({ cpf, nome, tipo:item.tipo||'receita', status:'aprovado', conteudo }) }); }
      document.getElementById('dlg').style.display='none';
      loadSummary(); loadDocs();
    };
  }
  document.querySelectorAll('.v').forEach(b=> b.onclick = ()=> openDlg(items.find(x=>x.id==b.dataset.id)));
  document.querySelectorAll('.a').forEach(b=> b.onclick = ()=> openDlg(items.find(x=>x.id==b.dataset.id)));
  document.querySelectorAll('.r').forEach(b=> b.onclick = async ()=>{ await api('/admin/docs/'+b.dataset.id+'/reject', { method:'POST', body: JSON.stringify({}) }); loadSummary(); loadDocs(); });
  document.querySelectorAll('.p').forEach(b=> b.onclick = ()=>{ const it=items.find(x=>x.id==b.dataset.id); const w=window.open('', '_blank'); w.document.write('<pre style="white-space:pre-wrap;font:16px/1.4 system-ui">'+(it.conteudo||'')+'</pre>'); w.document.close(); });
}

document.getElementById('buscar').onclick = ()=>{ loadSummary(); loadDocs(); };
document.getElementById('imprimirPeriodo').onclick = ()=> window.print();
document.getElementById('histBtn').onclick = async ()=>{
  const cpf = (document.getElementById('histCPF').value||'').replace(/\D/g,'');
  const d = await api('/admin/records/history?cpf='+cpf);
  const box = document.getElementById('histBox'); box.style.display='block';
  box.innerHTML = '<h3>Histórico do CPF '+cpf+'</h3>' + (d.items||[]).map(it=>'<div class="card"><div>#'+it.id+' — '+it.tipo+' — '+it.status+' — '+fmt(it.createdAt)+'</div><details><summary>Ver conteúdo</summary><pre>'+ (it.conteudo||'').replace(/[<>&]/g, s=>({"<":"&lt;",">":"&gt;","&":"&amp;"}[s])) +'</pre></details></div>').join('');
};

loadSummary(); loadDocs();
async function referir(id){
  const cpf = prompt("CPF do paciente para o encaminhamento (somente números):", "");
  if(!cpf) return;
  const motivo = prompt("Motivo/Resumo do encaminhamento (editável):", "Encaminhamento para avaliação presencial devido ao quadro relatado e necessidade de exame físico.");
  try{
    const r = await api("/admin/docs/"+id+"/refer", { method:"POST", body: JSON.stringify({ cpf, resumo: motivo }) });
    if(!r.ok) return alert("Falha ao encaminhar.");
    alert("Encaminhamento criado e aprovado. O paciente verá na recepção em Documentos.");
    await carregar(); // recarrega lista
  }catch(e){ alert("Erro ao encaminhar."); }
}
</script>
</body>
</html>
