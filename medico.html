<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Médico – Queimadas Telemedicina</title>
  <style>
    :root{
      --azul:#0c2e4e;
      --bolha:#e7f1ff;
      --bolha-user:#d8f7e5;
      --borda:#cfe0ff;
      --verde:#0c9447;
    }
    body{
      margin:0; background:#f6f8fb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#0b1b2b;
    }
    header{
      background:var(--azul); color:#fff; padding:8px 12px 16px;
      display:flex; flex-direction:column; align-items:center; gap:8px;
    }
    header .banner{ width:100%; max-width:1100px; border-radius:8px; overflow:hidden; }
    header h1{ font-size: clamp(18px, 3.8vw, 28px); margin: 6px 0 0; font-weight:700; }
    .wrap{
      max-width: 980px; margin: 12px auto; padding: 0 12px;
    }
    .chat{
      background:#fff; border:1px solid #e6ebf5; border-radius:12px; padding:12px; min-height:50vh;
      display:flex; flex-direction:column; gap:10px;
    }
    .msg{
      max-width: 85%; border-radius:14px; padding:12px 14px; line-height:1.35; font-size:16px;
      border:1px solid var(--borda);
      box-shadow: 0 1px 0 rgba(10,30,60,.03);
    }
    .m-med{ background: var(--bolha); align-self:flex-start; }
    .m-user{ background: var(--bolha-user); align-self:flex-end; }
    .status{ align-self:center; font-size:14px; color:#375; padding:4px 10px; background:#eefbf3; border-radius:999px; border:1px solid #d3f1e2; }
    .rodape{
      display:flex; gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap;
    }
    .rodape .filebtn{ background:var(--azul); color:#fff; border:none; padding:12px 14px; border-radius:12px; font-weight:600; }
    .rodape input[type="file"]{ display:none; }
    .rodape .inpt{ flex:1 1 240px; border:1px solid #cfd8ea; border-radius:12px; padding:12px 14px; font-size:16px; }
    .rodape .send{ background:#0e8240; color:#fff; border:none; padding:12px 20px; border-radius:12px; font-weight:700; }
    .logo-rodape{ display:block; margin:10px auto 0; opacity:.9; max-width:220px; }
    @media (max-width:480px){
      .msg{ font-size:15px; }
    }
  </style>
</head>
<body>
  <header>
    <img class="banner" src="prefeitura-queimadas.jpg" alt="Prefeitura de Queimadas" />
    <h1>Queimadas Telemedicina</h1>
  </header>

  <main class="wrap">
    <section class="chat" id="chat"></section>

    <div class="rodape">
      <label class="filebtn">
        Enviar arquivo
        <input id="file" type="file" accept="image/*,.pdf,.jpg,.jpeg,.png" />
      </label>
      <input id="msg" class="inpt" placeholder="Escreva sua resposta..." />
      <button id="send" class="send">Enviar</button>
    </div>

    <img class="logo-rodape" src="atende-mais.png" alt="Atende Mais" />
  </main>

  <script>
    // ====== Config ======
    const API_BASE = "https://remedy-queimadas-api.onrender.com";
    const ESPECIALIDADE = new URLSearchParams(location.search).get("especialidade") || "Clínico Geral";

    // ====== Estado ======
    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("send");
    const fileInput = document.getElementById("file");

    const historico = []; // {role, content}
    let indicador;

    function addMsg(role, text){
      const div = document.createElement("div");
      div.className = "msg " + (role === "assistant" ? "m-med" : "m-user");
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;

      // Se a resposta contém STATUS aguardando receita, envia para fila do administrador
      try{
        if(role === "assistant" && /\[STATUS:\s*aguardando receita\]/i.test(text)){
          const pacienteNome = localStorage.getItem('pacienteNome') || "";
          const pacienteCPF = localStorage.getItem('pacienteCPF') || "";
          fetch(API_BASE + "/admin/docs", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ tipo:"receita", pacienteNome, pacienteCPF, conteudo: text })
          }).catch(()=>{});
        }
      }catch(_e){}
    }
    function status(txt){
      clearStatus();
      indicador = document.createElement("div");
      indicador.className = "status";
      indicador.textContent = txt;
      chat.appendChild(indicador);
      chat.scrollTop = chat.scrollHeight;

      // Se a resposta contém STATUS aguardando receita, envia para fila do administrador
      try{
        if(role === "assistant" && /\[STATUS:\s*aguardando receita\]/i.test(text)){
          const pacienteNome = localStorage.getItem('pacienteNome') || "";
          const pacienteCPF = localStorage.getItem('pacienteCPF') || "";
          fetch(API_BASE + "/admin/docs", {
            method:"POST",
            headers:{ "Content-Type":"application/json" },
            body: JSON.stringify({ tipo:"receita", pacienteNome, pacienteCPF, conteudo: text })
          }).catch(()=>{});
        }
      }catch(_e){}
    }
    function clearStatus(){
      if (indicador && indicador.parentNode){
        indicador.parentNode.removeChild(indicador);
      }
    }
    function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function pensandoEDigitando(texto){
  const words = String(texto||"").trim().split(/\s+/).filter(Boolean).length || 10;
  const pensarMin = 15000, pensarMax = 30000;
  const pensar = Math.floor(pensarMin + Math.random()*(pensarMax - pensarMin));
  status("Médico pensando…");
  await delay(pensar);
  const typePerWord = 2300;
  const digitar = Math.max(6900, Math.round(words * typePerWord));
  status("Médico digitando…");
  await delay(digitar);
}

    async function acordarServidor(){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 12000);
      try { await fetch(`${API_BASE}/health`, { signal: ctrl.signal }); }
      catch(e){ /* tudo bem, seguimos */ }
      finally { clearTimeout(t); }
    }

    async function chamarIA(){
      const body = {
        specialty: ESPECIALIDADE,
        history: historico,
        patientMeta: {}
      };
      const resp = await fetch(`${API_BASE}/api/medico/chat`, {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body: JSON.stringify(body)
      });
      if(!resp.ok) throw new Error("Falha ao contatar IA");
      const data = await resp.json();
      if(!data.ok) throw new Error("IA indisponível");
      return data.reply;
    }

    async function enviarTexto(){
      const txt = (input.value || "").trim();
      if(!txt) return;
      historico.push({ role:"user", content: txt });
      addMsg("user", txt);
      input.value = "";
      try{
        const resposta = await chamarIA();
        await pensandoEDigitando(resposta);
        historico.push({ role:"assistant", content: resposta });
        addMsg("assistant", resposta);
      }catch(e){
        addMsg("assistant", "Não consegui contato com o servidor agora. Vamos tentar novamente em alguns segundos. Se persistir, volte para a recepção.");
        console.error(e);
      }
    }

    // Upload "simples" (local) – o arquivo não vai para o servidor nesta versão.
    fileInput.addEventListener("change", async (ev)=>{
      const f = ev.target.files?.[0];
      if(!f) return;
      addMsg("assistant", "Arquivos recebidos. Obrigado! (análise em breve)");
      historico.push({ role:"user", content:`[Paciente informa que enviou um arquivo: ${f.name} (${Math.round(f.size/1024)} KB). Oriente a enviar fotos nítidas/boas se necessário e siga com a anamnese.]` });
      try{
        const resposta = await chamarIA();
        await pensandoEDigitando(resposta);
        historico.push({ role:"assistant", content: resposta });
        addMsg("assistant", resposta);
      }catch(e){
        addMsg("assistant", "Parece que houve um problema no contato com o servidor. Poderia tentar novamente?");
      }finally{
        fileInput.value = "";
      }
    });

    sendBtn.addEventListener("click", enviarTexto);
    input.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ enviarTexto(); }
    });

    // Fluxo inicial
    (async () => {
      // banner inicial
      const saud = "Olá, sou o Médico de " + ESPECIALIDADE + ". Vou dar continuidade ao seu atendimento.";
      addMsg("assistant", saud);
      historico.push({ role:"assistant", content: saud });

      try{
        status("Preparando seu atendimento…");
        await acordarServidor();

        // Médico inicia com uma primeira pergunta objetiva
        historico.push({ role:"user", content: "Inicie a consulta com uma pergunta objetiva sobre o motivo da consulta. Lembre de usar linguagem simples e apenas UMA pergunta." });
        const primeira = await chamarIA();
        await pensandoEDigitando(primeira);
        historico.push({ role:"assistant", content: primeira });
        addMsg("assistant", primeira);
      }catch(e){
        addMsg("assistant", "Não consegui contato com o servidor agora. Vamos tentar novamente em alguns segundos. Se persistir, volte para a recepção.");
        console.error(e);
      }finally{
        clearStatus();
      }
    })();
  </script>

<script>
// ===== Ajustes solicitados (sem alterar layout) =====

// Frases padrão
const FRASE_FORA_MEDICINA = "Desculpe, só posso ajudar com assuntos médicos nesta plataforma. Descreva seu problema de saúde para seguirmos o atendimento.";
const FRASE_PERSONA_MEDICO = "Sou o médico responsável pelo seu atendimento aqui. Vamos focar no seu quadro clínico para eu te ajudar da melhor forma.";

// Estado de controle (não visual)
window.__receitaAguardando = window.__receitaAguardando || false;
window.__ultimaMsgPaciente = "";
window.__traumaReportado = false;

// Proteção: evitar pedido de foto da cabeça em cefaleia típica (permitir somente se trauma/lesão relatado)
function filtrarPedidoFotoSeNecessario(textoAssistente){
  try{
    const pedeFoto = /\bfoto\b|\bimagem\b|\banexar\b/i.test(textoAssistente||"");
    if(!pedeFoto) return textoAssistente;
    if(window.__traumaReportado) return textoAssistente; // permitido quando trauma/lesão
    // Remove frases que pedem foto (mantém o resto)
    return String(textoAssistente).split(/(?<=[\.\!\?])\s+/).filter(
      s=>!/\bfoto\b|\bimagem\b|\banexar\b/i.test(s)
    ).join(" ").trim() || "Vamos continuar a anamnese. Conte mais sobre seus sintomas, por favor.";
  }catch(e){ return textoAssistente; }
}

// Evitar receitas duplicadas após já constar [STATUS: aguardando receita]
function bloquearReceitaDuplicada(textoAssistente){
  const temStatus = /\[STATUS:\s*aguardando receita\]/i.test(textoAssistente||"");
  if(temStatus && window.__receitaAguardando){
    return "Já registrei sua prescrição nesta consulta. Posso esclarecer as dúvidas, mas a receita permanece a mesma.";
  }
  return textoAssistente;
}

// Detector simples de assuntos fora de medicina
function isForaDeMedicina(txt){
  const t = (txt||"").toLowerCase();
  const naoMed = [
    "futebol","time","jogo","videogame","filme","série","musica","música",
    "bitcoin","cripto","bolsa de valores","ações","investimento","imposto","irpf",
    "programação","javascript","python","site","html","css",
    "política","eleição","presidente","prefeito","vereador",
    "carro","moto","automóvel","celular","iphone","android"
  ];
  return naoMed.some(k=>t.includes(k));
}

// Ganchos na função de envio e no addMsg
(function(){
  const __orig_addMsg = window.addMsg;
  if(typeof __orig_addMsg === "function"){
    window.addMsg = function(role, text){
      if(role === "assistant"){
        // Atualiza flag de receita em aberto
        if(/\[STATUS:\s*aguardando receita\]/i.test(text||"")){
          window.__receitaAguardando = true;
        }
        // Filtrar pedido de foto indevido e impedir duplicidade de receita
        let filtrado = filtrarPedidoFotoSeNecessario(String(text||""));
        filtrado = bloquearReceitaDuplicada(filtrado);
        return __orig_addMsg(role, filtrado);
      }
      return __orig_addMsg(role, text);
    };
  }

  // Intercepta envio de texto para tratar IA/persona e fora de medicina
  const btn = document.getElementById("send");
  const inp = document.getElementById("msg");
  if(btn && inp && typeof window.enviarTexto === "function"){
    const __orig_enviar = window.enviarTexto;
    window.enviarTexto = async function(){
      const txt = (inp.value||"").trim();
      if(!txt) return;
      window.__ultimaMsgPaciente = txt;
      window.__traumaReportado = /trauma|les[aã]o|ferida|queda|batida|acidente|hematoma|corte|lacera[çc][aã]o/i.test(txt);
      // Pergunta "você é IA?"
      if(/\b(voc[eê]\s*(é|e)\s*(ia|intelig[eê]ncia artificial|rob[oô]|bot)|voc[eê]\s*(é|e)\s*humano)\b/i.test(txt)){
        addMsg("user", txt);
        inp.value="";
        addMsg("assistant", FRASE_PERSONA_MEDICO);
        return;
      }
      // Assuntos fora de medicina
      if(isForaDeMedicina(txt)){
        addMsg("user", txt);
        inp.value="";
        addMsg("assistant", FRASE_FORA_MEDICINA);
        return;
      }
      // fluxo normal
      return __orig_enviar.apply(this, arguments);
    };
  }
})();
</script>

</body>
</html>
