<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <title>Queimadas Telemedicina — Médico</title>
  <style>
    :root {
      --bg:#0f2e46; --fg:#0b2233; --card:#f3f7fb; --accent:#0a7a4b; --muted:#6b7b8c;
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:#f1f5f9; color:#0b2233; }
    header { background: var(--bg); color:#fff; padding:16px 12px 10px; text-align:center; }
    .brand { max-width:980px; margin:0 auto; }
    .banner {
      height:86px; background:#0f2e46 url('img/banner-queimadas.jpg') center/cover no-repeat;
      border-radius:12px; margin:4px auto 12px; max-width:980px;
    }
    h1 { margin:0 0 4px; font-size:28px; line-height:1.2; }
    main { max-width:980px; margin:18px auto; padding:0 12px 28px; }
    .chat-card {
      background:var(--card); border-radius:16px; padding:14px; min-height:420px;
      box-shadow: 0 6px 20px rgba(2,23,38,0.06), 0 2px 6px rgba(2,23,38,0.05);
    }
    #chatBox {
      background:#fff; border-radius:14px; height:54vh; min-height:360px; overflow:auto;
      padding:14px 12px; border:1px solid #e5edf4;
    }
    .msg { max-width:86%; padding:10px 12px; margin:8px 0; border-radius:14px; line-height:1.4; white-space:pre-wrap; }
    .msg.user { margin-left: auto; background:#dff4ff; border:1px solid #c9e7f7; }
    .msg.bot  { margin-right: auto; background:#f7fafc; border:1px solid #e7eef5; }
    .row { display:flex; gap:10px; align-items:center; margin-top:14px; flex-wrap:wrap; }
    .row .file-btn { background:#0f2e46; color:#fff; border:none; padding:14px 18px; border-radius:12px; font-weight:600; }
    .row input[type="text"], .row textarea {
      flex:1; border:1px solid #cfe0ec; background:#fff; border-radius:12px; padding:12px 14px; min-height:46px;
      outline:none; font-size:16px;
    }
    .row button.send { background:#117a51; color:#fff; border:none; border-radius:12px; padding:12px 18px; font-weight:700; min-width:108px; }
    .muted { color: var(--muted); font-size:13px; margin-top:8px; }
    .notice { background:#fff3cd; border:1px solid #ffe08a; color:#664d03; padding:10px 12px; border-radius:10px; margin:10px 0 0; }
    .hidden { display:none !important; }
  </style>
</head>
<body>
  <header>
    <div class="brand">
      <div class="banner" role="img" aria-label="Queimadas - banner"></div>
      <h1>Queimadas Telemedicina</h1>
    </div>
  </header>

  <main>
    <div id="redirNotice" class="notice hidden"></div>
    <div class="chat-card">
      <div id="chatBox" aria-live="polite"></div>
      <div class="row">
        <button class="file-btn" id="fileBtn" type="button">Enviar arquivo</button>
        <input id="chatInput" type="text" placeholder="Escreva sua resposta..." autocomplete="off">
        <button id="sendBtn" class="send" type="button">Enviar</button>
      </div>
      <div class="muted">Por segurança, a sala expira após 3 minutos de inatividade.</div>
    </div>
  </main>

  <script>
    // Você pode sobrescrever via <script> window.API_BASE = "https://seu-servico.onrender.com" </script> antes deste script.
    window.API_BASE = window.API_BASE || "https://remedy-queimadas-api.onrender.com";

    const THREE_MIN = 3 * 60 * 1000;
    let consultId = null;
    let history = [];
    let patientMeta = {};
    let idleTimer = null;

    const box = document.querySelector("#chatBox");
    const input = document.querySelector("#chatInput");
    const sendBtn = document.querySelector("#sendBtn");
    const fileBtn = document.querySelector("#fileBtn");
    const notice = document.querySelector("#redirNotice");

    function addMsg(role, text) {
      const el = document.createElement("div");
      el.className = role === "assistant" ? "msg bot" : "msg user";
      el.textContent = text;
      box.appendChild(el);
      box.scrollTo({ top: box.scrollHeight, behavior: "smooth" });
    }
    const addBot  = (t)=>addMsg("assistant", t);
    const addUser = (t)=>addMsg("user", t);

    function setDisabled(v) {
      input.disabled = !!v;
      sendBtn.disabled = !!v;
      fileBtn.disabled = !!v;
    }

    function readReceptionNotice() {
      const n = localStorage.getItem("reimed_notice");
      if (n) {
        notice.textContent = n;
        notice.classList.remove("hidden");
        localStorage.removeItem("reimed_notice");
      }
    }

    function expireSession(redirect) {
      clearTimeout(idleTimer);
      setDisabled(true);
      sessionStorage.removeItem("reimed_consult");
      if (redirect) {
        localStorage.setItem("reimed_notice","Sua sessão expirou. Volte à recepção para iniciar uma nova consulta.");
        window.location.href = "index.html";
      } else {
        addBot("Sessão expirada. Volte à recepção para iniciar uma nova consulta.");
      }
    }
    function refreshIdle() {
      clearTimeout(idleTimer);
      idleTimer = setTimeout(()=>expireSession(false), THREE_MIN);
    }
    document.addEventListener("visibilitychange", ()=>{
      if (document.visibilityState === "visible") refreshIdle();
    });

    async function boot() {
      readReceptionNotice();
      refreshIdle();

      // Paciente vindo da recepção
      const p = JSON.parse(sessionStorage.getItem("reimed_patient") || "null");
      if (!p || !p.cpf) return expireSession(true);

      patientMeta = {
        cpf: String(p.cpf).replace(/\D/g,""),
        name: p.nome || "",
        age: p.idade || "",
        weight: p.peso || "",
        allergies: p.alergias || "",
        specialty: p.especialidade || "Clínico Geral"
      };

      try {
        const r = await fetch(`${API_BASE}/history/start`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({
            cpf: patientMeta.cpf,
            specialty: patientMeta.specialty,
            sessionId: (crypto?.randomUUID?.() || String(Date.now()))
          })
        });
        const j = await r.json();
        if (!j.ok || !j.consultId) throw new Error("start failed");
        consultId = j.consultId;
        sessionStorage.setItem("reimed_consult", JSON.stringify({ id: consultId, startedAt: Date.now() }));

        addBot("Olá! Sou o médico. Para prescrever com segurança, preciso confirmar sua idade, peso e alergias. Podemos começar?");
        setDisabled(false);
      } catch (e) {
        expireSession(true);
      }
    }

    async function send() {
      refreshIdle();
      const txt = (input.value || "").trim();
      if (!txt) return;
      addUser(txt);
      input.value = "";
      setDisabled(true);

      history.push({ role:"user", content: txt });

      // tenta registrar mensagem (não bloqueia)
      if (consultId) {
        fetch(`${API_BASE}/history/msg`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ consultId, role:"user", content: txt })
        }).catch(()=>{});
      }

      try {
        const r = await fetch(`${API_BASE}/api/medico/chat`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify({ history, patientMeta, specialty: patientMeta.specialty })
        });
        const j = await r.json();
        if (!j.ok) throw new Error("chat failed");
        const reply = j.reply || "Desculpe, estou indisponível agora.";
        history.push({ role:"assistant", content: reply });

        if (consultId) {
          fetch(`${API_BASE}/history/msg`, {
            method: "POST",
            headers: {"Content-Type":"application/json"},
            body: JSON.stringify({ consultId, role:"assistant", content: reply })
          }).catch(()=>{});
        }
        addBot(reply);
      } catch (e) {
        addBot("Não consegui contato com o servidor agora. Voltaremos à recepção...");
        setTimeout(()=>expireSession(true), 1400);
      } finally {
        setDisabled(false);
      }
    }

    sendBtn.addEventListener("click", send);
    input.addEventListener("keydown", (ev)=>{ if (ev.key === "Enter") send(); refreshIdle(); });
    fileBtn.addEventListener("click", ()=>refreshIdle());
    box.addEventListener("scroll", refreshIdle);

    boot();
  </script>
</body>
</html>
