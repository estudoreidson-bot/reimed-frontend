
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Sala do Médico</title>
  <style>
    :root { --azul:#0f3144; --borda:#e1e7ee; --verde:#157347; --cinza:#f5f9fc; }
    body { margin:0; background:var(--cinza); font-family:system-ui, -apple-system, 'Segoe UI', Roboto, Arial; }
    header { background:var(--azul); color:#fff; padding:14px 18px; text-align:center; font-weight:700 }
    main { max-width:980px; margin:18px auto; padding:0 12px; }
    .card { background:#fff; border:1px solid var(--borda); border-radius:14px; box-shadow:0 4px 16px rgba(0,0,0,.04);}
    .chat { min-height:60vh; max-height:70vh; overflow:auto; padding:16px; }
    .row { display:flex; margin:10px 0; gap:10px; align-items:flex-end }
    .bubble { max-width:76%; padding:12px 14px; border-radius:16px; line-height:1.35; border:1px solid var(--borda) }
    .from-bot .bubble { background:#ffffff }
    .from-user { justify-content:flex-end }
    .from-user .bubble { background:#dff7ea; border-color:#c5ecd8 }
    .footer { display:flex; gap:10px; padding:12px; border-top:1px solid var(--borda) }
    input[type=text] { flex:1; padding:12px 14px; border-radius:12px; border:1px solid var(--borda); font-size:16px; outline:none; }
    button.enviar { background:var(--verde); color:#fff; border:none; padding:12px 18px; border-radius:12px; font-weight:600; cursor:pointer }
    .muted { color:#60707f; font-size:13px; margin:10px 0 0 14px }
  </style>
</head>
<body>
  <header>Atendimento Médico</header>
  <main class="card">
    <div id="chat" class="chat"></div>
    <div class="footer">
      <input id="msg" type="text" placeholder="Escreva sua mensagem..." autocomplete="off" />
      <button id="send" class="enviar">Enviar</button>
    </div>
    <div class="muted">Por segurança, a sessão se encerra após 3 minutos sem atividade.</div>
  </main>
<script>
(() => {
  const API_BASE = window.API_BASE || "https://remedy-queimadas-api.onrender.com";
  const params = new URLSearchParams(location.search);
  const token = params.get('token');
  const cpf = params.get('cpf') || sessionStorage.getItem('cpf');

  if (!token) {
    // Volta silenciosamente à recepção se não houver token (sem alerta vermelho)
    location.replace('index.html');
    return;
  }

  const chat = document.getElementById('chat');
  const input = document.getElementById('msg');
  const sendBtn = document.getElementById('send');

  const state = { last: Date.now(), expired: false };
  const TTL = 3 * 60 * 1000; // 3 min

  function scrollBottom() { chat.scrollTop = chat.scrollHeight; }
  function row(html, cls='from-bot') {
    const r = document.createElement('div');
    r.className = 'row ' + cls;
    r.innerHTML = html;
    chat.appendChild(r); scrollBottom(); return r;
  }
  function bubble(text, who='bot') {
    const html = who==='bot'
      ? `<div class="bubble">${text}</div>`
      : `<div class="bubble">${text}</div>`;
    return row(html, who==='bot'?'from-bot':'from-user');
  }
  function thinkTimer(ms=1200) {
    return new Promise(r => setTimeout(r, ms));
  }

  async function boot() {
    bubble('Conectando com o médico...');
    try {
      const resp = await fetch(API_BASE + '/api/consult/handshake', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ token })
      });
      if (!resp.ok) throw new Error('hs '+resp.status);
      bubble('Sala pronta. Pode descrever seu quadro.');
      state.last = Date.now();
    } catch(e) {
      // Falhou o handshake: volta à recepção sem barulho
      setTimeout(() => location.replace('index.html'), 900);
      return;
    }
    scheduleExpiry();
  }

  function scheduleExpiry() {
    clearTimeout(state._timer);
    const rem = TTL - (Date.now() - state.last);
    state._timer = setTimeout(() => expire(), Math.max(800, rem));
  }

  function expire() {
    if (state.expired) return;
    state.expired = true;
    bubble('Sessão encerrada por inatividade. Redirecionando para a recepção...');
    setTimeout(() => location.replace('index.html'), 1200);
  }

  async function handleMessage(text) {
    text = (text||'').trim(); if (!text) return;
    bubble(text, 'user');
    state.last = Date.now(); scheduleExpiry();
    // Encaminhar mensagem ao backend
    try {
      const resp = await fetch(API_BASE + '/api/consult/message', {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ token, cpf, text })
      });
      if (!resp.ok) throw new Error('msg '+resp.status);
      const data = await resp.json();
      const reply = (data && (data.reply || data.text)) || '...';
      await thinkTimer(1200);
      bubble(reply);
    } catch(e) {
      await thinkTimer(1000);
      bubble('Não consegui contato agora. Tente novamente em alguns instantes.'); 
    }
  }

  sendBtn.addEventListener('click', () => { handleMessage(input.value); input.value=''; });
  input.addEventListener('keydown', (e) => { if (e.key==='Enter') { handleMessage(input.value); input.value=''; } });

  boot();
})();
</script>
</body>
</html>
