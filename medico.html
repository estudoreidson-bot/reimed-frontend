<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Médico – Queimadas Telemedicina</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
<header>
  <img class="qbanner" src="prefeitura-queimadas.jpg" alt="Prefeitura de Queimadas">
  <h1>Queimadas Telemedicina</h1>
</header>
<main>
  <div id="chat" class="chat" aria-live="polite"></div>

  <div class="inputbar">
    <button id="fileBtn" style="background:#0e3554;color:#fff;border:none;border-radius:12px;padding:12px 16px;font-weight:700">Enviar arquivo</button>
    <input id="file" type="file" accept="image/*,.pdf" style="display:none">
    <input id="msg" type="text" placeholder="Escreva sua resposta…">
    <button id="send">Enviar</button>
  </div>

  <footer class="atende"><img src="atende-mais.png" alt="Atende+"></footer>
</main>

<script>
const API_BASE = (localStorage.getItem('API_BASE')||'https://remedy-queimadas-api.onrender.com');
const chat = document.getElementById('chat');
const input = document.getElementById('msg');
const send = document.getElementById('send');
const file = document.getElementById('file');
const fileBtn = document.getElementById('fileBtn');
const specialty = localStorage.getItem('selectedSpecialty')||'Clínico Geral';
const sessionId = localStorage.getItem('sessionId')||'';

function guard(){
  if(!localStorage.getItem('triageComplete')){
    location.replace('receptionist.html');
  }
}
guard();

function bubble(text, who='med'){
  const d = document.createElement('div');
  d.className='msg '+(who==='me'?'eu':'med');
  d.textContent=text;
  chat.appendChild(d); chat.scrollTop = chat.scrollHeight;
}

function statusLine(text){
  const d = document.createElement('div');
  d.className='msg system thinking';
  d.textContent = text;
  chat.appendChild(d); chat.scrollTop = chat.scrollHeight;
  return d;
}

function humanDelays(text){
  const think = Math.min(5000, Math.max(1500, text.length*40)); // 40ms/caractere
  const type = Math.min(8000, Math.max(1200, text.length*50));  // 50ms/caractere
  return {think,type};
}

async function askLLM(userText){
  const {think,type} = humanDelays(userText||'ok');
  const thinking = statusLine('Médico pensando…');
  await new Promise(r=>setTimeout(r, think));
  thinking.textContent = 'Médico digitando…';
  await new Promise(r=>setTimeout(r, type));

  const payload = { message: userText, specialty, sessionId };
  const r = await fetch(API_BASE+'/api/chat',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)})
  .then(r=>r.json()).catch(e=>({reply:"Não consegui contato com o servidor agora. Vamos tentar novamente em alguns segundos. Se persistir, volte para a recepção.", error:true}));

  if(r.error){
    thinking.textContent = r.reply;
  }else{
    thinking.remove();
    bubble(r.reply,'med');
  }
}

function sendMsg(){
  const v = input.value.trim();
  if(!v) return;
  bubble(v,'me'); input.value='';
  askLLM(v);
}
send.addEventListener('click', sendMsg);
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMsg(); }});
fileBtn.addEventListener('click', ()=> file.click());

file.addEventListener('change', async (e)=>{
  const f = e.target.files[0];
  if(!f) return;
  bubble('Enviando arquivo…','med');
  const b64 = await new Promise((resolve,reject)=>{
    const rd = new FileReader();
    rd.onload=()=>resolve(rd.result.split(',')[1]); rd.onerror=reject;
    rd.readAsDataURL(f);
  });
  const meta = {name:f.name,type:f.type,size:f.size};
  const body = { base64:b64, meta, specialty, sessionId };
  const res = await fetch(API_BASE+'/api/upload',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)})
   .then(r=>r.json()).catch(()=>({ok:false,msg:'Houve um problema no envio. Por favor, tente novamente.'}));
  bubble(res.msg || (res.ok?'Arquivo recebido.':'Houve um problema no envio. Tente novamente.'),'med');
});

// Mensagem de abertura do médico
bubble('Olá, sou o Médico de '+specialty+'. Vou dar continuidade ao seu atendimento.','med');
askLLM('Paciente conectado.');
</script>
</body>
</html>
