<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Médico – Queimadas Telemedicina</title>
  <style>
    :root{
      --azul:#0c2e4e;
      --bolha:#e7f1ff;
      --bolha-user:#d8f7e5;
      --borda:#cfe0ff;
      --verde:#0c9447;
    }
    body{
      margin:0; background:#f6f8fb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#0b1b2b;
    }
    header{
      background:var(--azul); color:#fff; padding:8px 12px 16px;
      display:flex; flex-direction:column; align-items:center; gap:8px;
    }
    header .banner{ width:100%; max-width:1100px; border-radius:8px; overflow:hidden; }
    header h1{ font-size: clamp(18px, 3.8vw, 28px); margin: 6px 0 0; font-weight:700; }
    .wrap{
      max-width: 980px; margin: 12px auto; padding: 0 12px;
    }
    .chat{
      background:#fff; border:1px solid #e6ebf5; border-radius:12px; padding:12px; min-height:50vh;
      display:flex; flex-direction:column; gap:10px;
    }
    .msg{
      max-width: 85%; border-radius:14px; padding:12px 14px; line-height:1.35; font-size:16px;
      border:1px solid var(--borda);
      box-shadow: 0 1px 0 rgba(10,30,60,.03);
    }
    .m-med{ background: var(--bolha); align-self:flex-start; }
    .m-user{ background: var(--bolha-user); align-self:flex-end; }
    .status{ align-self:center; font-size:14px; color:#375; padding:4px 10px; background:#eefbf3; border-radius:999px; border:1px solid #d3f1e2; }
    .rodape{
      display:flex; gap:10px; margin-top:10px; align-items:center; flex-wrap:wrap;
    }
    .rodape .filebtn{ background:var(--azul); color:#fff; border:none; padding:12px 14px; border-radius:12px; font-weight:600; }
    .rodape input[type="file"]{ display:none; }
    .rodape .inpt{ flex:1 1 240px; border:1px solid #cfd8ea; border-radius:12px; padding:12px 14px; font-size:16px; }
    .rodape .send{ background:#0e8240; color:#fff; border:none; padding:12px 20px; border-radius:12px; font-weight:700; }
    .logo-rodape{ display:block; margin:10px auto 0; opacity:.9; max-width:220px; }
    @media (max-width:480px){
      .msg{ font-size:15px; }
    }
  </style>
</head>
<script>
  (function(){
    if(!localStorage.getItem('patientToken')){
      location.replace('login.html');
    }
  })();

// ====== Poll de aprovações para exibir código ao paciente ======

// === Renderização da Receita em Imagem com aviso no topo ===
function renderPrescriptionImage(text, docId){
  try{
    const W = 1080;           // largura padrão para smartphones
    const H = 1528;           // altura proporcional (aprox. 1.414 * 1080 ~ A4)
    const P = 48;             // padding lateral
    const bannerH = 120;      // altura do aviso superior
    const lineH = 40;         // altura da linha do texto da receita

    const canvas = document.createElement('canvas');
    canvas.width = W;
    canvas.height = H;
    const ctx = canvas.getContext('2d');

    // fundo branco
    ctx.fillStyle = '#ffffff';
    ctx.fillRect(0,0,W,H);

    // banner superior
    ctx.fillStyle = '#0f172a'; // azul escuro do site
    ctx.fillRect(0,0,W,bannerH);
    ctx.fillStyle = '#ffffff';
    ctx.font = 'bold 36px system-ui, -apple-system, Segoe UI, Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'middle';
    const aviso = 'AVISO: leve esta imagem na Farmácia parceira ou Farmácia Básica do SUS.';
    ctx.fillText(aviso, W/2, bannerH/2);

    // título da receita
    ctx.fillStyle = '#0f172a';
    ctx.font = 'bold 44px system-ui, -apple-system, Segoe UI, Arial';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'top';
    ctx.fillText('Receita Médica', P, bannerH + 24);

    // corpo do texto (conteúdo aprovado)
    ctx.fillStyle = '#111827';
    ctx.font = '28px system-ui, -apple-system, Segoe UI, Arial';
    ctx.textAlign = 'left';
    const maxWidth = W - P*2;
    let y = bannerH + 24 + 56;

    const paragraphs = String(text||'').replace(/\r\n/g,'\n').split(/\n{2,}/);
    function wrapAndDraw(t){
      const words = t.split(/\s+/);
      let line = '';
      for(const w of words){
        const test = line ? line + ' ' + w : w;
        const m = ctx.measureText(test);
        if(m.width > maxWidth){
          ctx.fillText(line, P, y);
          y += lineH;
          line = w;
        }else{
          line = test;
        }
      }
      if(line){
        ctx.fillText(line, P, y);
        y += lineH;
      }
      y += 12;
    }
    for(const p of paragraphs){
      wrapAndDraw(p.trim());
    }

    // rodapé com carimbo simplificado
    y += 8;
    ctx.strokeStyle = '#e5e7eb';
    ctx.strokeRect(P, y, W - P*2, 140);
    ctx.fillStyle = '#374151';
    ctx.font = '24px system-ui, -apple-system, Segoe UI, Arial';
    ctx.fillText('Documento aprovado pelo médico responsável.', P+16, y+20);
    ctx.fillText('Apresente esta imagem na Farmácia parceira ou Básica.', P+16, y+58);
    ctx.fillText('ID do documento: #' + (docId||'-'), P+16, y+96);

    return canvas.toDataURL('image/png');
  }catch(e){
    return null;
  }
}

// === Exibição na conversa e download com clique ===
function showPrescriptionImage(base64Url, docId){
  if(!base64Url) return;
  const chat = document.getElementById('chat') || document.querySelector('.chat');
  const div = document.createElement('div');
  div.className = 'msg assistant';
  const img = document.createElement('img');
  img.src = base64Url;
  img.alt = 'Receita aprovada';
  img.style.maxWidth = '100%';
  img.style.borderRadius = '12px';
  img.style.border = '1px solid var(--borda)';
  img.style.cursor = 'pointer';
  img.title = 'Toque para baixar a imagem da receita';
  div.appendChild(img);
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;

  img.addEventListener('click', function(){
    try{
      const a = document.createElement('a');
      a.href = base64Url;
      a.download = 'receita-' + (docId||'aprovada') + '.png';
      document.body.appendChild(a);
      a.click();
      a.remove();
    }catch(_){ /* silencioso */ }
  });
}

(function initApprovalPolling(){
  const shown = new Set();
  async function poll(){
    try{
      const h = await fetch(`${API_BASE}/anon/docs?sid=${encodeURIComponent(ANON_SID||"")}` , {
        headers:{ "Authorization":"Bearer "+(localStorage.getItem('patientToken')||'') }
      });
      const data = await h.json().catch(()=>({}));
      if(!data || !data.items) return;
      for(const d of data.items){
        if(d.status === "aprovado" && d.approvalCode && !shown.has(d.id)){
          shown.add(d.id);
          const msg = [
            "Receita aprovada.",
            "Como proceder na Farmácia Popular, Básica do SUS ou parceira:",
            "1) Leve um documento com CPF.",
            "2) Mostre este código de aprovação ao atendente: " + d.approvalCode,
            "3) O atendente validará e dispensará conforme a receita aprovada."
          ].join("\n");
          addMsg("assistant", msg);
          // Gera imagem da receita com aviso no topo e mostra com clique para download
          try{
            const imgUrl = renderPrescriptionImage(d.conteudo || '', d.id);
            showPrescriptionImage(imgUrl, d.id);
          }catch(_){ /* silencioso */ }
        
        }
      }
    }catch(e){ /* silencioso */ }
  }
  setInterval(poll, 10000);
  poll();
})();

</script>

<body>
  <header>
    <img class="banner" src="prefeitura-queimadas.jpg" alt="Prefeitura de Queimadas" />
    <h1>Queimadas Telemedicina</h1>
  </header>

  <main class="wrap">
    <section class="chat" id="chat"></section>

    <div class="rodape">
      <label class="filebtn">
        Enviar arquivo
        <input id="file" type="file" accept="image/*,.pdf,.jpg,.jpeg,.png" />
      </label>
      <input id="msg" class="inpt" placeholder="Escreva sua resposta..." />
      <button id="send" class="send">Enviar</button>
    </div>

    <img class="logo-rodape" src="atende-mais.png" alt="Atende Mais" />
  </main>

  <script>
    // ====== Config ======
    const API_BASE = "https://remedy-queimadas-api.onrender.com";
    // === Sessão anônima (sem CPF/login) ===
    let ANON_SID = localStorage.getItem("ANON_SID") || "";
    async function ensureAnonSID(){
      try{
        if(ANON_SID) return ANON_SID;
        const r = await fetch(`${API_BASE}/anon/start`, { method:"POST" });
        const d = await r.json().catch(()=>({}));
        if(d && d.sid){ ANON_SID = d.sid; localStorage.setItem("ANON_SID", ANON_SID); }
        return ANON_SID;
      }catch(_){ return ""; }
    }

    const ESPECIALIDADE = (localStorage.getItem("selectedSpecialty") || new URLSearchParams(location.search).get("especialidade") || "Clínico Geral");

    // ====== Estado ======
    const chat = document.getElementById("chat");
    const input = document.getElementById("msg");
    const sendBtn = document.getElementById("send");
    const fileInput = document.getElementById("file");

    const historico = []; // {role, content}
    let indicador;

    function addMsg(role, text){
      const div = document.createElement("div");
      div.className = "msg " + (role === "assistant" ? "m-med" : "m-user");
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;

      // Se a resposta contém STATUS aguardando receita, envia para fila do administrador
      try{
        if(role === "assistant" && /\[STATUS:\s*aguardando receita\]/i.test(text)){
          const pacienteNome = localStorage.getItem('pacienteNome') || "";
          const pacienteCPF = localStorage.getItem('pacienteCPF') || "";
          fetch(API_BASE + "/admin/docs", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ tipo:"receita", conteudo: text, sid: ANON_SID }) }).catch(()=>{});
        }
      }catch(_e){}
    }
    function status(txt){
      clearStatus();
      indicador = document.createElement("div");
      indicador.className = "status";
      indicador.textContent = txt;
      chat.appendChild(indicador);
      chat.scrollTop = chat.scrollHeight;

      // Se a resposta contém STATUS aguardando receita, envia para fila do administrador
      try{
        if(role === "assistant" && /\[STATUS:\s*aguardando receita\]/i.test(text)){
          const pacienteNome = localStorage.getItem('pacienteNome') || "";
          const pacienteCPF = localStorage.getItem('pacienteCPF') || "";
          fetch(API_BASE + "/admin/docs", { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify({ tipo:"receita", conteudo: text, sid: ANON_SID }) }).catch(()=>{});
        }
      }catch(_e){}
    }
    function clearStatus(){
      if (indicador && indicador.parentNode){
        indicador.parentNode.removeChild(indicador);
      }
    }
    function delay(ms){ return new Promise(r => setTimeout(r, ms)); }

    async function pensandoEDigitando(texto){
  const words = String(texto||"").trim().split(/\s+/).filter(Boolean).length || 10;
  const pensarMin = 15000, pensarMax = 30000;
  const pensar = Math.floor(pensarMin + Math.random()*(pensarMax - pensarMin));
  status("Médico pensando…");
  await delay(pensar);
  const typePerWord = 1700;
  const digitar = Math.max(3400, Math.round(words * typePerWord));
  status("Médico digitando…");
  await delay(digitar);
clearStatus();
}

    async function acordarServidor(){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 12000);
      try { await fetch(`${API_BASE}/health`, { signal: ctrl.signal }); }
      catch(e){ /* tudo bem, seguimos */ }
      finally { clearTimeout(t); }
    }

    async function chamarIA(){
      await ensureAnonSID();
      const body = {
        specialty: ESPECIALIDADE,
        history: historico,
        patientMeta: {}
      };
      const resp = await fetch(`${API_BASE}/api/medico/chat`, { method:"POST", headers:{ "Content-Type":"application/json" }, body: JSON.stringify(Object.assign({}, body, { sid: ANON_SID }))
      });
      if(!resp.ok) throw new Error("Falha ao contatar IA");
      const data = await resp.json();
      if(!data.ok) throw new Error("IA indisponível");
      return data.reply;
    }

    async function enviarTexto(){
      const txt = (input.value || "").trim();
      if(!txt) return;
      historico.push({ role:"user", content: txt });
      addMsg("user", txt);
      input.value = "";
      try{
        const resposta = await chamarIA();
        await pensandoEDigitando(resposta);
        historico.push({ role:"assistant", content: resposta });
        addMsg("assistant", resposta);
      }catch(e){
        addMsg("assistant", "Não consegui contato com o servidor agora. Vamos tentar novamente em alguns segundos. Se persistir, volte para a recepção.");
        console.error(e);
      }
    }

    // Upload "simples" (local) – o arquivo não vai para o servidor nesta versão.
    fileInput.addEventListener("change", async (ev)=>{
      const f = ev.target.files?.[0];
      if(!f) return;
      addMsg("assistant", "Arquivos recebidos. Obrigado! (análise em breve)");
      historico.push({ role:"user", content:`[Paciente informa que enviou um arquivo: ${f.name} (${Math.round(f.size/1024)} KB). Oriente a enviar fotos nítidas/boas se necessário e siga com a anamnese.]` });
      try{
        const resposta = await chamarIA();
        await pensandoEDigitando(resposta);
        historico.push({ role:"assistant", content: resposta });
        addMsg("assistant", resposta);
      }catch(e){
        addMsg("assistant", "Parece que houve um problema no contato com o servidor. Poderia tentar novamente?");
      }finally{
        fileInput.value = "";
      }
    });

    sendBtn.addEventListener("click", enviarTexto);
    input.addEventListener("keydown", (e)=>{
      if(e.key === "Enter"){ enviarTexto(); }
    });

    // Fluxo inicial
    (async () => {
      // banner inicial
      const saud = "Olá, sou o Médico de " + ESPECIALIDADE + ". Vou dar continuidade ao seu atendimento.";
      addMsg("assistant", saud);
      historico.push({ role:"assistant", content: saud });

      try{
        status("Preparando seu atendimento…");
        await acordarServidor();

        // Médico inicia com uma primeira pergunta objetiva
        historico.push({ role:"user", content: "Inicie a consulta com uma pergunta objetiva sobre o motivo da consulta. Lembre de usar linguagem simples e apenas UMA pergunta." });
        const primeira = await chamarIA();
        await pensandoEDigitando(primeira);
        historico.push({ role:"assistant", content: primeira });
        addMsg("assistant", primeira);
        try{
          fetch(API_BASE+'/patient/consultas', {
            method:'POST',
            headers:{ 'Content-Type':'application/json', 'Authorization':'Bearer '+(localStorage.getItem('patientToken')||'') },
            body: JSON.stringify({ specialty: ESPECIALIDADE, messages: historico, assistant: primeira })
          });
        }catch(e){ console.warn('log consulta falhou', e); }
      }catch(e){
        addMsg("assistant", "Não consegui contato com o servidor agora. Vamos tentar novamente em alguns segundos. Se persistir, volte para a recepção.");
        console.error(e);
      }finally{
        clearStatus();
      }
    })();
  
// ====== Poll de aprovações para exibir código ao paciente ======
(function initApprovalPolling(){
  const shown = new Set();
  async function poll(){
    try{
      const h = await fetch(`${API_BASE}/anon/docs?sid=${encodeURIComponent(ANON_SID||"")}` , {
        headers:{ "Authorization":"Bearer "+(localStorage.getItem('patientToken')||'') }
      });
      const data = await h.json().catch(()=>({}));
      if(!data || !data.items) return;
      for(const d of data.items){
        if(d.status === "aprovado" && d.approvalCode && !shown.has(d.id)){
          shown.add(d.id);
          const msg = [
            "Receita aprovada.",
            "Como proceder na Farmácia Popular, Básica do SUS ou parceira:",
            "1) Leve um documento com CPF.",
            "2) Mostre este código de aprovação ao atendente: " + d.approvalCode,
            "3) O atendente validará e dispensará conforme a receita aprovada."
          ].join("\n");
          addMsg("assistant", msg);
        }
      }
    }catch(e){ /* silencioso */ }
  }
  setInterval(poll, 10000);
  poll();
})();

</script>
</body>
</html>
