<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Médico IA – Atendimento</title>
  <style>
    body { margin:0; font-family:Inter, system-ui, Arial; background:#E9F3FC; }
    .chat { height:100vh; display:flex; flex-direction:column; }
    header { padding:12px 16px; background:#0F3566; color:white; display:flex; align-items:center; gap:12px; }
    .content { flex:1; padding:16px; display:flex; flex-direction:column; gap:12px; overflow:auto; }
    .msg { max-width:80%; padding:10px 14px; border-radius:14px; border:1px solid #C9E2F8; }
    .patient { background:#fff; align-self:flex-start; }
    .doctor { background:#DCF2FF; align-self:flex-end; }
    .typing { color:#3F6EA5; font-size:14px; }
    .composer { display:flex; gap:8px; padding:12px; background:white; border-top:1px solid #C9E2F8;}
    .composer input { flex:1; padding:12px; border-radius:10px; border:1px solid #C9E2F8; }
    .composer button { padding:12px 18px; border:none; border-radius:10px; background:#0A6CC2; color:white; font-weight:700; cursor:pointer; }
  </style>
</head>
<body>
<div class="chat">
  <header><strong>Médico IA</strong></header>
  <div id="log" class="content"></div>
  <div class="composer">
    <input id="in" placeholder="Digite sua resposta..." />
    <button id="send">Enviar</button>
  </div>
</div>
<script>
const log = document.getElementById('log');
const input = document.getElementById('in');
const send = document.getElementById('send');

const params = new URLSearchParams(location.search);
const cpf = params.get('cpf') || '';
const spec = params.get('spec') || 'Clínico Geral';

function typingDelay(text) {{
  const len = text.length;
  let ms;
  if (len <= 20) ms = 60_000 + Math.random()*60_000;
  else if (len <= 40) ms = 120_000 + Math.random()*60_000;
  else if (len <= 60) ms = 180_000 + Math.random()*40_000;
  else ms = 220_000 + Math.random()*80_000;
  return Math.max(ms, 20_000);
}}

function add(role, text) {{
  const el = document.createElement('div');
  el.className = 'msg ' + role;
  el.textContent = text;
  log.appendChild(el);
  log.scrollTop = log.scrollHeight;
}}

function ask(text) {{
  const t = document.createElement('div');
  t.className = 'typing';
  t.textContent = 'Médico IA está digitando…';
  log.appendChild(t);
  log.scrollTop = log.scrollHeight;
  const ms = typingDelay(text);
  setTimeout(()=>{{ t.remove(); add('doctor', text); }}, ms);
}}

function nextQuestion(step) {{
  if (step===0) ask("Sou o Médico IA de " + spec + ". Para entender melhor, qual é o principal motivo da consulta hoje?");
  if (step===1) ask("Há quanto tempo isso começou e como tem evoluído?");
  if (step===2) ask("Você tem alguma alergia ou usa medicações regularmente? Se sim, quais?");
  if (step===3) ask("Pode me enviar exames, fotos ou PDFs que considere relevantes?");
  if (step===4) ask("Com base no que conversamos, vou montar um resumo SOAP e propor uma conduta inicial. Deseja prosseguir?");
}}

let step = 0;
nextQuestion(step);

send.addEventListener('click', handle);
input.addEventListener('keydown', e=>{{ if (e.key==='Enter') handle(); }});

function handle() {{
  const txt = input.value.trim();
  if (!txt) return;
  add('patient', txt);
  input.value = '';
  step += 1;
  if (step <= 4) nextQuestion(step);
  else {{
    // Encaminhamento ao médico humano (simulado)
    ask("Encaminhando seu caso ao médico humano para revisão. Assim que for aprovado, sua receita e documentos ficarão disponíveis aqui.");
    setTimeout(()=>{{ location.href = './medico.html?cpf='+encodeURIComponent(cpf)+'&spec='+encodeURIComponent(spec); }}, 4000);
  }}
}}
</script>
</body>
</html>
