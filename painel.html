<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Painel da Recepção</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0}
    .wrap{max-width:980px;margin:40px auto;background:#fff;padding:28px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.07)}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:18px}
    h1{margin:0;font-size:24px}
    button,.btn{padding:10px 14px;border:0;border-radius:10px;font-weight:700;cursor:pointer;background:#2563eb;color:#fff;text-decoration:none}
    .muted{color:#555}
    pre{background:#0b1020;color:#e6edf3;padding:12px;border-radius:10px;overflow:auto}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-top:14px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:14px}
    label{display:block;margin:10px 0 6px;font-weight:600}
    input,textarea{width:100%;padding:10px;border:1px solid #d8dbe2;border-radius:10px}
    textarea{min-height:110px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Painel da Recepção</h1>
      <div>
        <span id="who" class="muted"></span>
        <button id="logout" style="margin-left:10px">Sair</button>
      </div>
    </header>

    <div class="grid">
      <div class="card">
        <h3>Verificar API</h3>
        <button id="btnHealth">GET /health</button>
        <button id="btnHello" style="margin-left:8px">GET /api/hello</button>
        <pre id="out1"></pre>
      </div>

      <div class="card">
        <h3>Rota protegida</h3>
        <button id="btnProt">GET /api/admin/protegida</button>
        <pre id="out2"></pre>
      </div>

      <div class="card">
        <h3>Receitas por período (PDF)</h3>
        <label>De</label>
        <input id="dtFrom" type="date"/>
        <label>Até</label>
        <input id="dtTo" type="date"/>
        <button id="btnPdf" style="margin-top:10px">Abrir PDF</button>
        <p class="muted">O PDF abre em nova aba; use Ctrl+P para imprimir tudo.</p>
      </div>

      <div class="card">
        <h3>Salvar receita (teste)</h3>
        <p class="muted">Cole/edite os campos e clique “Salvar receita”. Vai acumular no servidor e sair no PDF por data.</p>
        <label>JSON da receita</label>
        <textarea id="rxJson">{
  "data": "2025-08-11T10:30:00Z",
  "pacienteNome": "Fulano de Tal",
  "pacienteCPF": "11122233344",
  "medico": "Dra. Exemplo",
  "crm": "CRM-BA 00000",
  "medicamentos": [
    { "nome": "Dipirona 500mg", "dose": "1 comp", "posologia": "6/6h se dor" }
  ],
  "observacoes": "Tomar com água."
}</textarea>
        <div style="display:flex;gap:10px;margin-top:10px">
          <button id="btnSaveRx">Salvar receita</button>
          <button id="btnOpenPdf">Abrir PDF deste mês</button>
        </div>
        <pre id="outSave"></pre>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = 'https://remedy-queimadas-api.onrender.com';
    const token = localStorage.getItem('token');

    function requireAuth(){ if(!token){ window.location.href='./receptionist.html'; } }
    function decodeJwt(t){ try{ const b=t.split('.')[1]; return JSON.parse(atob(b.replace(/-/g,'+').replace(/_/g,'/'))); }catch{ return null; } }
    function show(el, data){ el.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2); }

    requireAuth();
    const payload = decodeJwt(token);
    document.getElementById('who').textContent = payload ? `CPF ${payload.cpf} • role ${payload.role}` : '';

    document.getElementById('logout').onclick = () => { localStorage.removeItem('token'); window.location.href='./receptionist.html'; };

    document.getElementById('btnHealth').onclick = async () => { const r=await fetch(API_BASE+'/health'); show(document.getElementById('out1'), await r.json()); };
    document.getElementById('btnHello').onclick = async () => { const r=await fetch(API_BASE+'/api/hello'); show(document.getElementById('out1'), await r.json()); };
    document.getElementById('btnProt').onclick = async () => {
      const r=await fetch(API_BASE+'/api/admin/protegida',{headers:{Authorization:'Bearer '+token}});
      const t=await r.text(); let j; try{ j=JSON.parse(t) } catch { j={raw:t} }
      show(document.getElementById('out2'), { status:r.status, body:j });
    };

    // PDF por período
    document.getElementById('btnPdf').onclick = () => {
      const from=document.getElementById('dtFrom').value;
      const to=document.getElementById('dtTo').value;
      const url=`${API_BASE}/api/prescricoes/relatorio.pdf?from=${encodeURIComponent(from)}&to=${encodeURIComponent(to)}&token=${encodeURIComponent(token)}`;
      window.open(url,'_blank');
    };

    // Salvar receita de teste
    document.getElementById('btnSaveRx').onclick = async () => {
      const txt = document.getElementById('rxJson').value;
      let obj;
      try { obj = JSON.parse(txt); }
      catch { show(document.getElementById('outSave'), 'JSON inválido'); return; }

      const r = await fetch(API_BASE+'/api/prescricoes', {
        method:'POST',
        headers:{'Content-Type':'application/json', Authorization:'Bearer '+token},
        body: JSON.stringify(obj)
      });
      const t = await r.text(); let j; try{ j=JSON.parse(t) } catch { j={ raw:t } }
      show(document.getElementById('outSave'), { status:r.status, body:j });
    };

    // Abrir PDF do mês da data da receita do textarea (atalho)
    document.getElementById('btnOpenPdf').onclick = () => {
      try {
        const obj = JSON.parse(document.getElementById('rxJson').value);
        const d = new Date(obj.data || new Date().toISOString());
        const from = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-01`;
        const to = `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-28`;
        const url=`${API_BASE}/api/prescricoes/relatorio.pdf?from=${from}&to=${to}&token=${encodeURIComponent(token)}`;
        window.open(url,'_blank');
      } catch { alert('JSON inválido'); }
    };
  </script>
</body>
</html>
