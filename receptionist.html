<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Recepção – Queimadas Telemedicina</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <img class="qbanner" src="prefeitura-queimadas.jpg" alt="Prefeitura de Queimadas">
    <h1>Queimadas Telemedicina</h1>
  </header>

  <main>
    <div id="chat" class="chat" aria-live="polite">
      <div class="msg recep" id="welcome">Recepção está digitando…</div>
      <div id="especialidades" class="msg recep" style="display:none">
        <div><strong>Selecione a especialidade para direcionarmos ao médico:</strong></div>
        <div id="lista-esp"></div>
      </div>
      <div id="pre-transfer" class="msg recep" style="display:none"></div>
      <div id="aguarde" class="msg system" style="display:none"></div>
    </div>

    <footer class="atende"><img src="atende-mais.png" alt="Atende+"></footer>
    <div class="legal">
      Base legal da Telemedicina no Brasil (resumo): legislação federal vigente e normas do CFM
      (ex.: Resolução CFM 2.314/2022), com observância à LGPD (Lei 13.709/2018). Atendimento
      remoto com registro em prontuário, identificação das partes e consentimento informado.
    </div>
  <div id="opcoesCPF" class="container"></div>
</main>

<script>
const chat = document.getElementById('chat');
const boxEsp = document.getElementById('especialidades');
const lista = document.getElementById('lista-esp');
const pre = document.getElementById('pre-transfer');
const aguarde = document.getElementById('aguarde');

function pushMsg(el){ chat.appendChild(el); chat.scrollTop = chat.scrollHeight; }

function typeMessage(text, klass="recep", min=10000){
  const m = document.createElement('div');
  m.className = 'msg '+klass;
  const delay = Math.max(min, Math.min(20000, text.length*60)); // 60ms por caractere, min 10s
  m.textContent = 'Recepção está digitando…';
  pushMsg(m);
  setTimeout(()=>{ m.textContent = text; }, delay);
  return new Promise(res=>setTimeout(res, delay+200));
}

// Welcome + load especialidades
(async ()=>{
  await typeMessage('Bem-vindo(a) à Queimadas Telemedicina!');
  await typeMessage('Escolha abaixo a especialidade para direcionarmos você ao médico adequado.');
  // carrega lista
  const data = await fetch('especialidades.json').then(r=>r.json()).catch(()=>[]);
  lista.innerHTML = '';
  for(const item of data){
    const b = document.createElement('button');
    b.className='btn'; b.type='button';
    b.innerHTML = '<strong>'+item.nome+'</strong><small>'+item.descricao+'</small>';
    b.addEventListener('click', ()=> selectSpecialty(item.nome));
    lista.appendChild(b);
  }
  boxEsp.style.display='block';
})();

async function selectSpecialty(nome){
  try{ localStorage.setItem('especialidade', nome); localStorage.setItem('cameFromReception','1'); }catch(e){}

  boxEsp.style.display='none';
  localStorage.setItem('selectedSpecialty', nome);
  await typeMessage('Especialidade escolhida: '+nome+'.', 'eu', 500);
  pre.style.display='block';
  pre.textContent = 'Certo. Vou encaminhar você para o médico de '+nome+'. Tempo estimado: _calculando…';
  const minutos = Math.floor(Math.random()*5)+1; // 1–5
  const total = minutos*60;
  let t=total;
  pre.innerHTML = 'Certo. Vou encaminhar você para o médico de <b>'+nome+'</b>. Tempo estimado: <b>'+minutos+' min</b>.';
  aguarde.style.display='block';
  const timer = document.createElement('div');
  timer.innerHTML = '<span class="badge">Aguardando atendimento: <span id="count">--:--</span></span>';
  aguarde.innerHTML='';
  aguarde.appendChild(timer);
  const span = timer.querySelector('#count');
  const iv = setInterval(()=>{
     const mm = String(Math.floor(t/60)).padStart(1,'0');
     const ss = String(t%60).padStart(2,'0');
     span.textContent = mm+':'+ss;
     if(--t<0){ clearInterval(iv); conectar(); }
  },1000);
  // sinaliza fluxo válido
  localStorage.setItem('triageComplete','1');
}

function conectar(){
  // vai primeiro para a ponte que cria a sessão e redireciona
  location.href = 'paciente.html';
}
// ====== Fluxo: CPF -> opções (nova consulta / receitas/exames/encaminhamentos) ======
async function recepcaoIdentificarCPF(cpf){
  const cpfNum = String(cpf||"").replace(/\D/g,"");
  if(!cpfNum) return alert("Informe um CPF válido.");
  try{
    localStorage.setItem("pacienteCPF", cpfNum);
    const res = await fetch((localStorage.getItem("API_BASE")||"https://remedy-queimadas-api.onrender.com")+"/reception/check?cpf="+cpfNum);
    const data = await res.json();
    if(!data.ok) throw new Error(data.error||"Erro");
    // Monta painel de opções
    const msg = data.docs && data.docs.length ? 
      "Encontrei registros para este CPF. O que você deseja?" : 
      "Não encontrei registros para este CPF. Quer iniciar um cadastro e uma nova consulta?";
    const div = document.createElement('div');
    div.className = "card";
    div.innerHTML = "<p>"+msg+"</p>";
    const b1 = document.createElement('button'); b1.textContent = "Nova consulta"; b1.onclick = ()=>{ localStorage.setItem('cameFromReception','1'); window.location.href='paciente.html'; };
    div.appendChild(b1);
    if(data.docs && data.docs.length){
      const b2 = document.createElement('button'); b2.textContent = "Ver documentos (receitas/exames/encaminhamentos)"; b2.style.marginLeft="8px";
      b2.onclick = ()=> listarDocsDoCPF(cpfNum);
      div.appendChild(b2);
    }
    document.querySelector("#opcoesCPF")?.replaceChildren(div);
  }catch(e){
    alert("Falha ao consultar CPF.");
  }
}

async function listarDocsDoCPF(cpfNum){
  try{
    const base = (localStorage.getItem("API_BASE")||"https://remedy-queimadas-api.onrender.com");
    const res = await fetch(base+"/admin/docs?cpf="+cpfNum, { headers: { /* público? usamos endpoint admin? melhor usar reception/check */ } });
    // Para não exigir token admin, vamos reutilizar /reception/check
    const res2 = await fetch(base+"/reception/check?cpf="+cpfNum);
    const data = await res2.json();
    if(!data.ok) throw new Error();
    const wrap = document.createElement('div'); wrap.className="card";
    let html = "<h3>Seus documentos</h3><ul>";
    for(const d of data.docs){
      const s = d.status;
      html += "<li>#"+d.id+" — "+d.tipo+" — "+s+" — "+new Date(d.createdAt).toLocaleString()+" ";
      if(s==="aprovado"){
        html += "<button onclick=\"baixarDoc("+d.id+",'"+cpfNum+"')\">Baixar</button>";
      } else {
        html += "<span class='pill pendente'>Aguardando aprovação</span>";
      }
      html += "</li>";
    }
    html += "</ul>";
    wrap.innerHTML = html;
    document.querySelector("#opcoesCPF")?.replaceChildren(wrap);
  }catch(e){ alert("Falha ao listar documentos."); }
}

async function baixarDoc(id, cpf){
  const base = (localStorage.getItem("API_BASE")||"https://remedy-queimadas-api.onrender.com");
  const r = await fetch(base+"/reception/docs/"+id+"?cpf="+cpf);
  const data = await r.json();
  if(!data.ok) return alert("Não foi possível abrir este documento.");
  if(data.status!=="aprovado") return alert("Documento ainda pendente.");
  const w = window.open("", "_blank");
  w.document.write("<pre style='white-space:pre-wrap;font:16px/1.4 system-ui,Segoe UI,Arial'>"+(data.conteudo||"")+"</pre>");
  w.document.close(); w.focus();
}
</script>
</body>
</html>
