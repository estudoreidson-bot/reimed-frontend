<!doctype html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Recepção – Queimadas Telemedicina</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <header>
    <img class="qbanner" src="prefeitura-queimadas.jpg" alt="Prefeitura de Queimadas">
    <h1>Queimadas Telemedicina</h1>
  </header>

  <main>
    <div id="chat" class="chat" aria-live="polite">
      <div class="msg recep" id="welcome">Recepção está digitando…</div>
      <div id="especialidades" class="msg recep" style="display:none">
        <div><strong>Selecione a especialidade para direcionarmos ao médico:</strong></div>
        <div id="lista-esp"></div>
      </div>
      <div id="pre-transfer" class="msg recep" style="display:none"></div>
      <div id="aguarde" class="msg system" style="display:none"></div>
    </div>

    <footer class="atende"><img src="atende-mais.png" alt="Atende+"></footer>
    <div class="legal">
      Base legal da Telemedicina no Brasil (resumo): Res. CFM 2.314/2022 e LGPD (Lei 13.709/2018).
    </div>
  </main>

<script>
const chat = document.getElementById('chat');
const boxEsp = document.getElementById('especialidades');
const lista = document.getElementById('lista-esp');
const pre = document.getElementById('pre-transfer');
const aguarde = document.getElementById('aguarde');

const API_BASE = 'https://remedy-queimadas-api.onrender.com';
const TOKEN = (localStorage.getItem('token')||'').trim();

async function api(path, opts={}){
  const r = await fetch(API_BASE + path, {
    headers: { 'Content-Type': 'application/json', ...(TOKEN ? {'Authorization': 'Bearer '+TOKEN}: {}) },
    ...opts
  });
  if(!r.ok){
    let msg=''; try{ const j=await r.json(); msg = j.message || j.detail || j.error || ''; }catch{}
    throw new Error(msg || ('HTTP '+r.status));
  }
  const ct = r.headers.get('content-type')||'';
  return ct.includes('application/json') ? r.json() : r.text();
}

function pushMsg(el){ chat.appendChild(el); chat.scrollTop = chat.scrollHeight; }

function typeMessage(text, klass="recep", min=1000){
  const m = document.createElement('div');
  m.className = 'msg '+klass;
  const delay = Math.max(min, Math.min(4000, text.length*30));
  m.textContent = 'Recepção está digitando…';
  pushMsg(m);
  setTimeout(()=>{ m.textContent = text; }, delay);
  return new Promise(res=>setTimeout(res, delay+100));
}

function makeChoices(){
  const wrap = document.createElement('div');
  wrap.className = 'msg recep';
  wrap.innerHTML = `
    <div style="margin-bottom:8px;"><strong>Como você deseja ser atendido hoje?</strong></div>
    <div style="display:flex;gap:8px;flex-wrap:wrap">
      <button type="button" class="btn" id="opt-consulta">Consulta</button>
      <button type="button" class="btn" id="opt-historico">Histórico de consultas</button>
      <button type="button" class="btn" id="opt-contato">Entre em contato</button>
    </div>
  `;
  return wrap;
}

function askMode(){
  return new Promise((resolve)=>{
    const el = makeChoices();
    pushMsg(el);
    el.querySelector('#opt-consulta').addEventListener('click', ()=>resolve('consulta'));
    el.querySelector('#opt-historico').addEventListener('click', ()=>resolve('historico'));
    el.querySelector('#opt-contato').addEventListener('click', ()=>resolve('contato'));
  });
}

async function showHistorico(){
  if(!TOKEN){
    await typeMessage('Você precisa entrar com seu CPF/senha para ver seu histórico.', 'syst
