<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Recepção – Queimadas Telemedicina</title>
  <style>
    :root {
      --q1:#0A6CC2; --q2:#12A84E; --bg:#E9F3FC; --tx:#0B2B4C;
      --bubbleP:#FFFFFF; --bubbleS:#DCF2FF; --bd:#C9E2F8;
    }
    * { box-sizing:border-box; }
    html,body { height:100%; margin:0; font-family:Inter,system-ui,Arial; background:var(--bg); }
    .app { height:100%; display:flex; flex-direction:column; }
    header { padding:12px 16px; background:#0F3566; color:#fff; display:flex; align-items:center; gap:12px; }
    header .t { font-weight:800; }
    .chat { flex:1; display:flex; flex-direction:column; gap:12px; padding:16px; overflow-y:auto; }
    .msg { max-width:78%; padding:10px 14px; border-radius:14px; border:1px solid var(--bd); font-size:15px; line-height:1.45; color:var(--tx);}
    .patient { align-self:flex-start; background:var(--bubbleP);}
    .staff { align-self:flex-end; background:var(--bubbleS);}
    .typing { color:#3F6EA5; font-size:14px; }
    .composer { display:flex; gap:8px; padding:12px; background:#fff; border-top:1px solid var(--bd);}
    .composer input { flex:1; padding:12px; border-radius:10px; border:1px solid var(--bd);}
    .composer button { padding:12px 18px; border:none; border-radius:10px; background:var(--q1); color:white; font-weight:700; }
  </style>
</head>
<body>
<div class="app">
  <header><div class="t">Recepção – Queimadas Telemedicina</div></header>
  <div id="chat" class="chat"></div>
  <div class="composer">
    <input id="in" placeholder="Escreva sua mensagem..." autocomplete="off" />
    <button id="send">Enviar</button>
  </div>
</div>

<script>
const API_BASE = "https://remedy-queimadas-api.onrender.com";

const chat = document.getElementById('chat');
const input = document.getElementById('in');
const sendBtn = document.getElementById('send');

function typingDelay(text) {
  const len = text.length;
  let ms;
  if (len <= 20) ms = 60_000 + Math.random()*60_000;    // 60–120s
  else if (len <= 40) ms = 120_000 + Math.random()*60_000; // 120–180s
  else if (len <= 60) ms = 180_000 + Math.random()*40_000; // 180–220s
  else ms = 220_000 + Math.random()*80_000;                // 220–300s
  return Math.max(ms, 20_000);
}

function showTyping(role='staff') {
  const el = document.createElement('div');
  el.className = 'typing';
  el.textContent = (role==='staff'?'Recepção':'Você') + ' está digitando…';
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
  return el;
}

function hideTyping(el) { if (el) el.remove(); }

function msg(text, role) {
  const el = document.createElement('div');
  el.className = 'msg ' + (role==='patient'?'patient':'staff');
  el.textContent = text;
  chat.appendChild(el);
  chat.scrollTop = chat.scrollHeight;
}

let state = { step:'cpf', cpf:null, hasRegistration:null };

function askCPF() {
  const t = "Olá! Bem-vindo(a) à Queimadas Telemedicina. Para começar, por favor, informe seu CPF para cadastro.";
  const typ = showTyping('staff');
  const ms = typingDelay(t);
  setTimeout(()=>{ hideTyping(typ); msg(t,'staff'); }, ms);
}

async function verifyCPF(cpf) {
  const typing = showTyping('staff');
  const info = "Verificando seu cadastro. Aguarde um instante.";
  const ms = typingDelay(info);
  setTimeout(()=>msg(info,'staff'), Math.max(1000, ms/3));

  let found = false;
  try {
    const r = await fetch(API_BASE + "/patients/exists?cpf=" + encodeURIComponent(cpf));
    if (r.ok) { const data = await r.json(); found = !!data.exists; }
  } catch(e) { /* mantém false */ }

  setTimeout(()=>{
    hideTyping(typing);
    if (found) onFound();
    else onNotFound();
  }, ms);
}

function onFound() {
  const t = "Cadastro encontrado. Seu atendimento será iniciado agora.";
  const typ = showTyping('staff');
  const ms = typingDelay(t);
  setTimeout(()=>{ hideTyping(typ); msg(t,'staff'); goToIA(); }, ms);
}

function onNotFound() {
  const t = "Não encontramos seu cadastro. Envie, por favor, numa única mensagem: Nome completo; Data de nascimento; Telefone/WhatsApp; E-mail (opcional); Cidade/UF; Alergias e medicações em uso.";
  const typ = showTyping('staff');
  const ms = typingDelay(t);
  setTimeout(()=>{ hideTyping(typ); msg(t,'staff'); state.step='register'; }, ms);
}

function afterRegister() {
  const t = "Cadastro concluído. Seu atendimento será iniciado agora.";
  const typ = showTyping('staff');
  const ms = typingDelay(t);
  setTimeout(()=>{ hideTyping(typ); msg(t,'staff'); goToIA(); }, ms);
}

function goToIA() {
  setTimeout(()=>{
    const url = new URL('./paciente.html', location.href);
    url.searchParams.set('cpf', state.cpf || '');
    location.href = url.toString();
  }, 1200);
}

sendBtn.addEventListener('click', send);
input.addEventListener('keydown', (e)=>{ if(e.key==='Enter') send(); });

function send() {
  const t = input.value.trim();
  if (!t) return;
  msg(t, 'patient');
  input.value='';

  if (state.step==='cpf') {
    state.cpf = t.replace(/\D/g,'');
    verifyCPF(state.cpf);
  } else if (state.step==='register') {
    state.hasRegistration = true; // MVP: assume ok
    afterRegister();
  }
}

// iniciar com 1s antes da animação
setTimeout(askCPF, 1200);
</script>
</body>
</html>
