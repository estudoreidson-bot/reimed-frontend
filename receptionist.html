<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Recepção – Login</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:#f6f7fb;margin:0}
    .wrap{max-width:560px;margin:48px auto;background:#fff;padding:32px;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.07)}
    h1{margin:0 0 4px;font-size:26px}
    p.desc{color:#555;margin:0 0 24px}
    label{display:block;font-weight:600;margin:16px 0 6px}
    input{width:100%;padding:12px 14px;border:1px solid #d8dbe2;border-radius:10px;font-size:16px}
    button{margin-top:18px;padding:12px 16px;border:0;border-radius:10px;font-weight:700;cursor:pointer;background:#2563eb;color:#fff}
    pre{background:#0b1020;color:#e6edf3;padding:14px;border-radius:10px;overflow:auto}
    .row{display:flex;gap:12px}.row>div{flex:1}.ok{color:#056d34}.err{color:#9b1c1c}.muted{color:#666;font-size:14px}.topbar{text-align:right;padding:12px}.link{color:#2563eb;text-decoration:none}
  </style>
</head>
<body>
  <div class="topbar"><a class="link" href="./index.html">Página inicial</a></div>
  <div class="wrap">
    <h1>Painel da Recepção</h1>
    <p class="desc">Use o CPF e a senha do Render (ADMIN_CPF, ADMIN_SENHA). As requisições vão direto para a API no Render.</p>
    <div class="row">
      <div><label>CPF</label><input id="cpf" inputmode="numeric" autocomplete="username" placeholder="00000000000"/></div>
      <div><label>Senha</label><input id="senha" type="password" autocomplete="current-password" placeholder="********"/></div>
    </div>
    <button id="btnLogin">Entrar</button>
    <p class="muted">Dica: digite o CPF apenas com números. O sistema também remove pontos e hífen automaticamente.</p>
    <div id="out" style="margin-top:22px;"></div>
  </div>
  <script>
    const API_BASE = 'https://remedy-queimadas-api.onrender.com';
    const loginPaths = ['/api/login','/api/reception/login','/api/receptionist/login','/api/admin/login'].map(p=>API_BASE+p);
    const protectedProbe = API_BASE + '/api/admin/protegida';
    const cpfEl=document.getElementById('cpf'), senhaEl=document.getElementById('senha'), out=document.getElementById('out');
    const normalizeCpf = s => String(s||'').replace(/\D/g,'');

    function show(msg, ok=false){ out.innerHTML = '<pre>'+msg+'</pre>'; out.className = ok ? 'ok' : 'err'; }

    async function tryLogin(url, cpf, senha){
      const res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ cpf, senha }) });
      const txt = await res.text(); let data; try{ data = JSON.parse(txt) } catch { data = { raw: txt } }
      return { status: res.status, data };
    }

    async function probe(token){
      const res = await fetch(protectedProbe, { headers: { Authorization: 'Bearer '+token } });
      const txt = await res.text(); let data; try{ data = JSON.parse(txt) } catch { data = { raw: txt } }
      return { status: res.status, data };
    }

    function goToPanel(){ window.location.href = './painel.html'; }

    document.getElementById('btnLogin').addEventListener('click', async () => {
      out.textContent = 'Autenticando...';
      const cpf = normalizeCpf(cpfEl.value);
      const senha = senhaEl.value;

      for(const url of loginPaths){
        try{
          const { status, data } = await tryLogin(url, cpf, senha);
          if(status === 200 && data.token){
            localStorage.setItem('token', data.token);
            const p = await probe(data.token);
            if (p.status === 200) { goToPanel(); return; }
            show('Token obtido, mas falhou na verificação da rota protegida: '+p.status+'\\n'+JSON.stringify(p.data,null,2));
            return;
          }
          if(status !== 404){
            show('Falhou em '+url+' -> status '+status+'\\n'+JSON.stringify(data,null,2));
          }
        }catch(e){
          show('Erro em '+url+'\\n'+(e && e.message ? e.message : e));
        }
      }
      show('Nenhuma rota respondeu 200. Revise as credenciais no Render.');
    });
  </script>
</body>
</html>
